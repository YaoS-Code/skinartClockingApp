# IP白名单配置说明

## 概述

IP白名单功能允许您限制只有特定IP地址或IP范围的用户才能访问ClockingApp系统。这对于云端部署时的安全访问控制非常有用。

## 配置方法

### 快速配置：仅允许局域网访问（推荐用于Mac Mini部署）

最简单的方式，自动允许所有局域网设备访问：

```env
IP_WHITELIST_ENABLED=true
IP_WHITELIST_LOCAL_ONLY=true
```

这会自动允许所有私有IP地址（192.168.x.x, 10.x.x.x, 172.16-31.x.x等），拒绝所有公网IP。

### 详细配置

#### 1. 启用IP白名单

在 `.env` 文件中设置：

```env
IP_WHITELIST_ENABLED=true
```

#### 2. 配置允许的IP地址

在 `.env` 文件中设置 `IP_WHITELIST` 环境变量：

```env
IP_WHITELIST="192.168.1.100,192.168.1.0/24,10.0.0.0-10.0.0.255"
```

## IP配置格式

### 单个IP地址

```
192.168.1.100
```

### CIDR格式（推荐）

```
192.168.1.0/24    # 允许192.168.1.0到192.168.1.255的所有IP
10.0.0.0/16       # 允许10.0.0.0到10.0.255.255的所有IP
172.16.0.0/12     # 允许172.16.0.0到172.31.255.255的所有IP
```

### IP段格式

```
192.168.1.0-192.168.1.255
10.0.0.0-10.0.0.255
```

## 配置示例

### 示例1: 仅允许办公室IP

```env
IP_WHITELIST_ENABLED=true
IP_WHITELIST="203.0.113.50,203.0.113.51,203.0.113.52"
```

### 示例2: 允许办公室IP段

```env
IP_WHITELIST_ENABLED=true
IP_WHITELIST="203.0.113.0/24"
```

### 示例3: 允许多个IP段

```env
IP_WHITELIST_ENABLED=true
IP_WHITELIST="203.0.113.0/24,198.51.100.0/24,192.168.1.100"
```

### 示例4: 混合格式

```env
IP_WHITELIST_ENABLED=true
IP_WHITELIST="203.0.113.50,203.0.113.0/24,10.0.0.0-10.0.0.255"
```

## 禁用IP白名单

如果不需要IP限制，可以：

1. 将 `IP_WHITELIST_ENABLED` 设置为 `false`
2. 或者删除/注释掉 `IP_WHITELIST_ENABLED` 环境变量

```env
IP_WHITELIST_ENABLED=false
```

## 工作原理

1. **代理支持**: 系统会自动检测并信任以下HTTP头中的IP地址：
   - `X-Forwarded-For` (最常见的代理头)
   - `X-Real-IP`
   - `CF-Connecting-IP` (Cloudflare)

2. **IP检查顺序**:
   - 首先检查是否为单个IP匹配
   - 然后检查CIDR范围
   - 最后检查IP段范围

3. **访问拒绝**: 如果IP不在白名单中，服务器将返回403错误

## 注意事项

1. **本地开发**: 在本地开发时，建议将 `IP_WHITELIST_ENABLED` 设置为 `false` 或添加 `127.0.0.1` 和 `::1` 到白名单

2. **动态IP**: 如果用户使用动态IP，可能需要定期更新白名单或使用VPN

3. **云服务商IP**: 某些云服务商（如AWS、Azure）可能需要添加整个IP段

4. **IPv6支持**: 系统支持IPv4和IPv6地址

5. **日志记录**: 所有被拒绝的IP访问都会记录在服务器日志中

## 测试配置

配置完成后，重启服务器：

```bash
pm2 restart server
# 或
npm start
```

可以通过访问API端点来测试配置是否正确：

```bash
# 从允许的IP访问
curl http://your-server:13000/api/auth/login

# 应该返回正常响应

# 从未允许的IP访问
# 应该返回403错误
```

## 故障排除

### 问题: 所有请求都被拒绝

**解决方案**: 
- 检查 `IP_WHITELIST` 配置是否正确
- 确认已添加您当前的IP地址
- 检查服务器日志查看检测到的IP地址

### 问题: IP白名单不生效

**解决方案**:
- 确认 `IP_WHITELIST_ENABLED=true` 已设置
- 重启服务器使配置生效
- 检查 `.env` 文件是否正确加载

### 问题: 无法获取真实IP

**解决方案**:
- 如果使用反向代理（如Nginx），确保配置了正确的代理头
- 检查 `app.js` 中的 `trust proxy` 设置
- 查看服务器日志中记录的IP地址

## 安全建议

1. **最小权限原则**: 只添加必要的IP地址
2. **定期审查**: 定期检查和更新IP白名单
3. **日志监控**: 监控被拒绝的访问尝试
4. **备用方案**: 考虑保留一个管理员IP用于紧急访问

